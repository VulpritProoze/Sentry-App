---
import Layout from '../layouts/Layout.astro';
---

<Layout 
	title="Reset Password - Sentry"
	description="Reset your Sentry account password"
>
	<main class="min-h-screen flex items-center justify-center px-4">
		<div class="max-w-md w-full">
			<div class="bg-white rounded-lg shadow-md p-8">
				<!-- Header -->
				<div class="text-center mb-6">
					<div class="text-5xl mb-4">üîí</div>
					<h1 class="text-2xl font-bold text-gray-900 mb-2">
						Reset Your Password
					</h1>
					<p class="text-gray-600">
						Enter your new password below to reset your account password
					</p>
				</div>

				<!-- Status Messages -->
				<div id="status-message" class="hidden mb-4 p-4 rounded-lg"></div>

				<!-- Reset Form -->
				<form id="reset-form" class="space-y-4">
					<div>
						<label for="new-password" class="block text-sm font-medium text-gray-700 mb-2">
							New Password
						</label>
						<input 
							type="password" 
							id="new-password"
							name="new-password"
							placeholder="Enter your new password"
							required
							minlength="8"
							class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
						/>
					</div>

					<div>
						<label for="confirm-password" class="block text-sm font-medium text-gray-700 mb-2">
							Confirm Password
						</label>
						<input 
							type="password" 
							id="confirm-password"
							name="confirm-password"
							placeholder="Confirm your new password"
							required
							minlength="8"
							class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
						/>
					</div>

					<div id="password-error" class="hidden text-red-600 text-sm"></div>

					<!-- Submit Button -->
					<button 
						type="submit"
						id="reset-btn"
						class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-blue-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed"
					>
						<span id="btn-text">Reset Password</span>
						<span id="btn-loading" class="hidden">Resetting...</span>
					</button>
				</form>

				<!-- Back to Home -->
				<div class="text-center mt-4">
					<a href="/" class="text-blue-600 hover:text-blue-700 text-sm">
						‚Üê Back to Home
					</a>
				</div>
			</div>
		</div>
	</main>

	<script>
		// Define API_BASE in the script context
		const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:8000';
		const API_BASE = `${API_URL}/api/v1`;

		const urlParams = new URLSearchParams(window.location.search);
		const token = urlParams.get('token');
		
		const resetForm = document.getElementById('reset-form') as HTMLFormElement;
		const resetBtn = document.getElementById('reset-btn') as HTMLButtonElement;
		const btnText = document.getElementById('btn-text') as HTMLSpanElement;
		const btnLoading = document.getElementById('btn-loading') as HTMLSpanElement;
		const statusMessage = document.getElementById('status-message') as HTMLDivElement;
		const passwordError = document.getElementById('password-error') as HTMLDivElement;
		const newPasswordInput = document.getElementById('new-password') as HTMLInputElement;
		const confirmPasswordInput = document.getElementById('confirm-password') as HTMLInputElement;

		function showMessage(message: string, isError: boolean = false) {
			statusMessage.textContent = message;
			statusMessage.className = `mb-4 p-4 rounded-lg ${
				isError 
					? 'bg-red-100 text-red-700 border border-red-300' 
					: 'bg-green-100 text-green-700 border border-green-300'
			}`;
			statusMessage.classList.remove('hidden');
		}

		function setLoading(loading: boolean) {
			resetBtn.disabled = loading;
			if (loading) {
				btnText.classList.add('hidden');
				btnLoading.classList.remove('hidden');
			} else {
				btnText.classList.remove('hidden');
				btnLoading.classList.add('hidden');
			}
		}

		function validatePasswords(): boolean {
			const password = newPasswordInput.value;
			const confirmPassword = confirmPasswordInput.value;

			// Clear previous error styling
			newPasswordInput.classList.remove('border-red-500');
			newPasswordInput.classList.add('border-gray-300');

			if (password !== confirmPassword) {
				passwordError.textContent = 'Passwords do not match';
				passwordError.classList.remove('hidden');
				return false;
			}

			if (password.length < 8) {
				passwordError.textContent = 'Password must be at least 8 characters long';
				passwordError.classList.remove('hidden');
				return false;
			}

			passwordError.classList.add('hidden');
			return true;
		}

		// Real-time password validation
		confirmPasswordInput.addEventListener('input', validatePasswords);
		newPasswordInput.addEventListener('input', () => {
			if (confirmPasswordInput.value) {
				validatePasswords();
			}
		});

		if (!token) {
			showMessage('No reset token found in URL. Please check your email for the password reset link.', true);
			resetForm.style.display = 'none';
		} else {
			resetForm.addEventListener('submit', async (e) => {
				e.preventDefault();
				
				if (!validatePasswords()) {
					return;
				}

				setLoading(true);
				statusMessage.classList.add('hidden');
				// Clear previous validation errors
				passwordError.classList.add('hidden');
				newPasswordInput.classList.remove('border-red-500');
				newPasswordInput.classList.add('border-gray-300');

				try {
					const response = await fetch(`${API_BASE}/core/auth/email/reset-password`, {
						method: 'POST',
						headers: { 
							'Content-Type': 'application/json' 
						},
						body: JSON.stringify({ 
							token,
							new_password: newPasswordInput.value
						})
					});

					const data = await response.json();

					if (response.ok) {
						showMessage(data.message || 'Password reset successfully! You can now log in with your new password.', false);
						resetForm.style.display = 'none';
						resetBtn.textContent = 'Password Reset ‚úì';
					} else {
						// Handle validation errors (Django Ninja returns errors in 'detail' field)
						if (data.detail && Array.isArray(data.detail)) {
							// Find password-related errors
							const passwordErrors = data.detail.filter((err: any) => 
								err.field === 'new_password' || err.field === 'password'
							);
							
							if (passwordErrors.length > 0) {
								// Show validation errors
								const errorMessages = passwordErrors.map((err: any) => err.message).join(' ');
								passwordError.textContent = errorMessages;
								passwordError.classList.remove('hidden');
								
								// Highlight the input field
								newPasswordInput.classList.add('border-red-500');
								newPasswordInput.classList.remove('border-gray-300');
								
								// Show general error message
								showMessage('Please fix the password errors below.', true);
							} else {
								// Show other validation errors
								const errorMessages = data.detail.map((err: any) => err.message).join(' ');
								showMessage(errorMessages || 'Password reset failed. Please check your input.', true);
							}
						} else {
							// Handle non-validation errors
							showMessage(data.message || 'Password reset failed. The token may be invalid or has already been used.', true);
						}
					}
				} catch (error) {
					showMessage('An error occurred while resetting your password. Please try again later.', true);
					console.error('Password reset error:', error);
				} finally {
					setLoading(false);
				}
			});
		}
	</script>
</Layout>

